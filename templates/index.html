<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Claus' 3D Printer Dashboard</title>

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
const socket = io();

/* ---------- CLOCK ---------- */
function updateClock() {
    document.getElementById("clock").textContent =
        new Date().toLocaleTimeString();
}
setInterval(updateClock, 1000);

/* ---------- STATE COLORS ---------- */
function stateClass(text) {
    if (!text) return "state-offline";
    text = text.toLowerCase();
    if (text.includes("print")) return "state-printing";
    if (text.includes("pause")) return "state-paused";
    if (text.includes("operational")) return "state-idle";
    return "state-error";
}

/* ---------- SMART PAUSE / RESUME ---------- */
function togglePauseResume(printer, state) {
    const action = state.includes("pause") ? "resume" : "pause";
    fetch(`/api/control/${printer}/${action}`, { method: "POST" });
}

/* ---------- WEATHER TOGGLE ---------- */
function toggleWeather() {
    const content = document.getElementById("weather-content");
    const arrow = document.getElementById("weather-arrow");
    const open = content.classList.toggle("open");
    arrow.textContent = open ? "â–¼" : "â–¶";
    localStorage.setItem("weatherOpen", open);
}
function refreshCamera(id) {
    const img = document.getElementById(id);
    if (!img) return;

    const base = img.src.split("?")[0];
    img.src = base + "?action=stream&t=" + Date.now();
}

window.addEventListener("DOMContentLoaded", () => {
    const open = localStorage.getItem("weatherOpen") === "true";
    if (open) {
        document.getElementById("weather-content").classList.add("open");
        document.getElementById("weather-arrow").textContent = "â–¼";
    }

    // kick cameras once on load
    refreshCamera("cam-minimus");
    refreshCamera("cam-sprite");
});

// refresh every 30 seconds
setInterval(() => {
    refreshCamera("cam-minimus");
    refreshCamera("cam-sprite");
}, 30000);

// refresh when phone unlocks / tab becomes visible again
document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
        refreshCamera("cam-minimus");
        refreshCamera("cam-sprite");
    }
});



/* ---------- TEMP HISTORY ---------- */
const tempHistory = { minimus: [], sprite: [] };

/* ---------- SOCKET DATA ---------- */
socket.on("update", d => {

    /* ===== SYSTEM ===== */
    if (d.system) {
        document.getElementById("sys-cpu").textContent = d.system.cpu.toFixed(0);
        document.getElementById("sys-mem").textContent =
            `${d.system.mem_used}/${d.system.mem_total} GB (${d.system.mem_percent}%)`;
        document.getElementById("sys-disk").textContent =
            `${d.system.disk_used}/${d.system.disk_total} GB (${d.system.disk_percent}%)`;
        const u = d.system.uptime;
        document.getElementById("sys-up").textContent =
            `${Math.floor(u / 3600)}h ${Math.floor((u % 3600) / 60)}m`;
    }

    /* ===== WEATHER ===== */
    if (d.weather && !d.weather.error) {
        const w = d.weather;
        document.getElementById("w-temp").textContent = w.temp.toFixed(1);
        document.getElementById("w-feels").textContent = w.feels.toFixed(1);
        document.getElementById("w-hum").textContent = w.humidity;
        document.getElementById("w-wind").textContent = w.wind.toFixed(1);
        document.getElementById("w-clouds").textContent = w.clouds;
        document.getElementById("w-pressure").textContent = w.pressure;
        document.getElementById("w-vis").textContent = w.visibility.toFixed(1);
        document.getElementById("w-aqi").textContent = w.aqi;
        document.getElementById("w-pm25").textContent = w.pm25.toFixed(1);
        document.getElementById("w-rain").textContent = w.rain_prob.toFixed(0);
        document.getElementById("w-min").textContent = w.temp_min.toFixed(0);
        document.getElementById("w-max").textContent = w.temp_max.toFixed(0);
        document.getElementById("w-sunrise").textContent =
            new Date(w.sunrise * 1000).toLocaleTimeString();
        document.getElementById("w-sunset").textContent =
            new Date(w.sunset * 1000).toLocaleTimeString();
    }

    function updatePrinter(prefix, printer, job) {
        const status = printer?.state?.text || "Offline";
        const state = status.toLowerCase();

        /* ---------- STATUS ---------- */
        const s = document.getElementById(prefix + "-status");
        s.textContent = status;
        s.className = "status " + stateClass(status);

        /* ---------- FILE ---------- */
        const f = document.getElementById(prefix + "-file");
        if (job?.job?.file?.name) {
            f.textContent = job.job.file.name;
            f.style.display = "block";
        } else {
            f.style.display = "none";
        }

        /* ---------- TEMPS ---------- */
        if (printer?.temperature?.tool0) {
            const t = printer.temperature.tool0.actual;
            document.getElementById(prefix + "-hotend").textContent = t.toFixed(1) + " Â°C";
        }
        if (printer?.temperature?.bed) {
            document.getElementById(prefix + "-bed").textContent =
                printer.temperature.bed.actual.toFixed(1) + " Â°C";
        }

        /* ---------- PROGRESS (FIXED) ---------- */
        let progress = 0;

        if (typeof job?.progress?.completion === "number") {
            progress = job.progress.completion;
            if (progress > 0 && progress <= 1) progress *= 100;
        }

        if (
            (!progress || progress <= 0) &&
            typeof job?.progress?.filepos === "number" &&
            typeof job?.job?.file?.size === "number" &&
            job.job.file.size > 0
        ) {
            progress = (job.progress.filepos / job.job.file.size) * 100;
        }

        if (!Number.isFinite(progress)) progress = 0;
        progress = Math.max(0, Math.min(100, progress));

        const bar = document.getElementById(prefix + "-bar");
        bar.style.width =
            progress > 0 ? Math.max(progress, 4).toFixed(1) + "%" : "0%";


        /* ---------- TEXT ---------- */
        const p = document.getElementById(prefix + "-progress");
        if (state.includes("print") && job?.progress?.printTimeLeft) {
            const left = job.progress.printTimeLeft;
            const finish = new Date(Date.now() + left * 1000).toLocaleTimeString();
            p.textContent =
                `${progress.toFixed(1)}% Â· ${Math.floor(left / 60)}m left Â· Finishes ${finish}`;
        } else if (state.includes("pause")) {
            p.textContent = `${progress.toFixed(1)}% Â· Paused`;
        } else {
            p.textContent = "";
        }

        /* ---------- BUTTONS ---------- */
        const toggleBtn = document.getElementById(prefix + "-toggle");
        if (state.includes("print")) {
            toggleBtn.style.display = "inline-block";
            toggleBtn.textContent = "Pause";
            toggleBtn.onclick = () => togglePauseResume(prefix, state);
        } else if (state.includes("pause")) {
            toggleBtn.style.display = "inline-block";
            toggleBtn.textContent = "Resume";
            toggleBtn.onclick = () => togglePauseResume(prefix, state);
        } else {
            toggleBtn.style.display = "none";
        }

        document.getElementById(prefix + "-cancel").disabled =
            !(state.includes("print") || state.includes("pause"));
    }

    updatePrinter("minimus", d.minimus_printer, d.minimus_job);
    updatePrinter("sprite", d.sprite_printer, d.sprite_job);
});
</script>
</head>

<body>
<header>
    <h1>Claus' 3D Printer Dashboard</h1>
    <div id="clock">--:--:--</div>
    <div id="system-stats">
        ğŸ§  CPU <span id="sys-cpu">--</span>% |
        ğŸ’¾ RAM <span id="sys-mem">--</span> |
        ğŸ’½ Disk <span id="sys-disk">--</span> |
        â± <span id="sys-up">--</span>
    </div>
</header>

<div class="container">

<div class="box weather-box">
    <h2 class="collapsible" onclick="toggleWeather()">
        Weather <span id="weather-arrow">â–¶</span>
    </h2>
    <div id="weather-content" class="weather-content">
        <p>ğŸŒ¡ Temp: <span id="w-temp">--</span> Â°C (Feels <span id="w-feels">--</span>)</p>
        <p>ğŸ’§ Humidity: <span id="w-hum">--</span>%</p>
        <p>ğŸŒ¬ Wind: <span id="w-wind">--</span> m/s</p>
        <p>â˜ Clouds: <span id="w-clouds">--</span>%</p>
        <p>ğŸ“‰ Pressure: <span id="w-pressure">--</span> hPa</p>
        <p>ğŸ‘ Visibility: <span id="w-vis">--</span> km</p>
        <hr>
        <p>ğŸŒ« AQI: <span id="w-aqi">--</span> (PM2.5: <span id="w-pm25">--</span>)</p>
        <hr>
        <p>ğŸŒ§ Rain chance (1h): <span id="w-rain">--</span>%</p>
        <p>ğŸ“† Today: <span id="w-min">--</span>Â° / <span id="w-max">--</span>Â°</p>
        <hr>
        <p>ğŸŒ… Sunrise: <span id="w-sunrise">--</span></p>
        <p>ğŸŒ‡ Sunset: <span id="w-sunset">--</span></p>
    </div>
</div>

<div class="box">
    <h2>Minimus</h2>
    <p id="minimus-file" style="display:none;"></p>
    <p>Status: <span id="minimus-status">--</span></p>
    <p>Hotend: <span id="minimus-hotend">--</span></p>
    <p>Bed: <span id="minimus-bed">--</span></p>
    <div class="progress"><div id="minimus-bar" class="progress-fill"></div></div>
    <p id="minimus-progress"></p>
    <button id="minimus-toggle" style="display:none;">Pause</button>
    <button id="minimus-cancel" class="cancel">Cancel</button>
    <div class="camera">
        <img id="cam-minimus"
            src="http://192.168.2.51/cam_Ender3minimus/?action=stream">
    </div>
</div>

<div class="box">
    <h2>Sprite</h2>
    <p id="sprite-file" style="display:none;"></p>
    <p>Status: <span id="sprite-status">--</span></p>
    <p>Hotend: <span id="sprite-hotend">--</span></p>
    <p>Bed: <span id="sprite-bed">--</span></p>
    <div class="progress"><div id="sprite-bar" class="progress-fill"></div></div>
    <p id="sprite-progress"></p>
    <button id="sprite-toggle" style="display:none;">Pause</button>
    <button id="sprite-cancel" class="cancel">Cancel</button>
    <div class="camera">
        <img id="cam-sprite"
            src="http://192.168.2.51/cam_Ender3Sprite/?action=stream">
    </div>
</div>

</div>
</body>
</html>
